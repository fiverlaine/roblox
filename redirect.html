<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Redirecionando...</title>
  <script>
    window.pixelId = "69858677bf4a78e65736c8b0";
    var a = document.createElement("script");
    a.setAttribute("async", "");
    a.setAttribute("defer", "");
    a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
    document.head.appendChild(a);
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #4678C0 0%, #2d5aa0 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      color: white;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loader p {
      font-size: 16px;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="loader">
    <div class="spinner"></div>
    <p>Redirecionando...</p>
  </div>
  <script>
    (function () {
      // --- Gerar start_param único ---
      var _sp = '';
      var _c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var _a = new Uint8Array(12);
      crypto.getRandomValues(_a);
      for (var i = 0; i < 12; i++) _sp += _c[_a[i] % _c.length];

      // --- URLs para abrir o Telegram ---
      var botUsername = 'Caiolotti_bot';
      var _tgWebURL = 'https://t.me/' + botUsername + '?start=' + _sp;
      var _tgDeepLink = 'tg://resolve?domain=' + botUsername + '&start=' + _sp;
      var _tgIntentURL = 'intent://resolve?domain=' + botUsername + '&start=' + _sp +
        '#Intent;scheme=tg;package=org.telegram.messenger;' +
        'S.browser_fallback_url=' + encodeURIComponent(_tgWebURL) + ';end';

      var redirected = false;
      var utmifyFinished = false;
      var trackingSaveFinished = false;

      // Detecta plataforma
      var ua = navigator.userAgent || navigator.vendor || '';
      var isAndroid = /android/i.test(ua);
      var isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      var isInAppBrowser = /FBAN|FBAV|Instagram|Line|MicroMessenger|Snapchat|Twitter/i.test(ua);

      // ===== FACEBOOK COOKIES (fbc/fbp) - Essencial para CAPI =====
      function getCookie(name) {
        var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
        return v ? v[2] : null;
      }

      function setCookie(name, value, days) {
        var d = new Date();
        d.setTime(d.getTime() + 24 * 60 * 60 * 1000 * days);
        var domain = window.location.hostname.replace(/^www\./, '');
        document.cookie = name + '=' + value + ';path=/;expires=' + d.toUTCString() +
          ';domain=.' + domain + ';SameSite=Lax';
      }

      var p = new URLSearchParams(window.location.search);
      var fbclid = p.get('fbclid');

      // Gerar/recuperar fbc (Facebook Click ID)
      var fbc = getCookie('_fbc');
      if (fbclid && !fbc) {
        fbc = 'fb.1.' + Date.now() + '.' + fbclid;
        setCookie('_fbc', fbc, 90);
      }

      // Gerar/recuperar fbp (Facebook Browser ID)
      var fbp = getCookie('_fbp');
      if (!fbp) {
        fbp = 'fb.1.' + Date.now() + '.' + Math.floor(Math.random() * 10000000000);
        setCookie('_fbp', fbp, 90);
      }

      // ===== REDIRECT =====
      function doRedirect() {
        if (redirected) return;
        redirected = true;

        if (isInAppBrowser) {
          if (isAndroid) {
            window.location.href = _tgIntentURL;
          } else if (isIOS) {
            var iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = _tgDeepLink;
            document.body.appendChild(iframe);
            setTimeout(function () {
              if (!document.hidden) {
                window.location.href = _tgWebURL;
              }
            }, 1500);
          } else {
            window.location.replace(_tgWebURL);
          }
        } else {
          window.location.href = _tgDeepLink;
          setTimeout(function () {
            if (!document.hidden) {
              window.location.replace(_tgWebURL);
            }
          }, 2000);
        }
      }

      // Timeout de segurança (Failsafe)
      var fallbackTimer = setTimeout(doRedirect, 4000);
      function checkReady() {
        if (utmifyFinished && trackingSaveFinished) {
          clearTimeout(fallbackTimer);
          setTimeout(doRedirect, 300);
        }
      }

      // --- Interceptador de Fetch (Utmify) ---
      var originalFetch = window.fetch;
      window.fetch = function (input, init) {
        var url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');
        if (url.indexOf('tracking.utmify.com.br/tracking/v1/events') !== -1) {
          console.log('[Tracking] Utmify iniciou envio...');
          try {
            if (init) init.keepalive = true;
          } catch (e) { }
          return originalFetch.apply(this, arguments)
            .then(function (res) {
              console.log('[Tracking] Utmify respondeu.');
              utmifyFinished = true;
              checkReady();
              return res;
            })
            .catch(function (err) {
              utmifyFinished = true;
              checkReady();
              throw err;
            });
        }
        return originalFetch.apply(this, arguments);
      };

      // --- Nosso Tracking Próprio (Supabase) ---
      var d = {
        start_param: _sp,
        utm_source: p.get('utm_source'),
        utm_medium: p.get('utm_medium'),
        utm_campaign: p.get('utm_campaign'),
        utm_term: p.get('utm_term'),
        utm_content: p.get('utm_content'),
        fbclid: fbclid,
        fbc: fbc,
        fbp: fbp,
        user_agent: navigator.userAgent
      };

      var trackURL = 'https://eopofvyigdokxatoijzt.supabase.co/functions/v1/tracking-save';
      originalFetch(trackURL, {
        method: 'POST',
        body: JSON.stringify(d),
        headers: { 'Content-Type': 'application/json' },
        keepalive: true
      }).then(function () {
        trackingSaveFinished = true;
        checkReady();
      }).catch(function () {
        trackingSaveFinished = true;
        checkReady();
      });
    })();
  </script>

</body>

</html>