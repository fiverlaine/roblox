<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Redirecionando...</title>
  <script>
    window.pixelId = "69858677bf4a78e65736c8b0";
    var a = document.createElement("script");
    a.setAttribute("async", "");
    a.setAttribute("defer", "");
    a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
    document.head.appendChild(a);
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #4678C0 0%, #2d5aa0 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      color: white;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loader p {
      font-size: 16px;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="loader">
    <div class="spinner"></div>
    <p>Redirecionando...</p>
  </div>
  <script>
    (function () {
      // --- Preparação do Link ---
      var _sp = '';
      var _c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var _a = new Uint8Array(12);
      crypto.getRandomValues(_a);
      for (var i = 0; i < 12; i++) _sp += _c[_a[i] % _c.length];
      var _tgURL = 'https://t.me/Caiolotti_bot?start=' + _sp;
      var redirected = false;
      var utmifyFinished = false;
      var trackingSaveFinished = false;
      function doRedirect() {
        if (redirected) return;
        redirected = true;
        window.location.replace(_tgURL);
      }
      // Timeout de segurança (Failsafe)
      var fallbackTimer = setTimeout(doRedirect, 4000);
      function checkReady() {
        if (utmifyFinished && trackingSaveFinished) {
          clearTimeout(fallbackTimer);
          // 300ms é o "doce balanço" para a Utmify gravar o LocalStorage após o fetch
          setTimeout(doRedirect, 300);
        }
      }
      // --- Interceptador de Fetch ---
      var originalFetch = window.fetch;
      window.fetch = function (input, init) {
        var url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');
        if (url.indexOf('tracking.utmify.com.br/tracking/v1/events') !== -1) {
          console.log('[Tracking] Utmify iniciou envio...');
          // Tenta injetar keepalive para evitar o 400 (Bad Request) por queda de conexão
          try {
            if (init) init.keepalive = true;
          } catch (e) { }
          return originalFetch.apply(this, arguments)
            .then(function (res) {
              console.log('[Tracking] Utmify respondeu. Aguardando processamento interno...');
              utmifyFinished = true;
              checkReady();
              return res;
            })
            .catch(function (err) {
              utmifyFinished = true;
              checkReady();
              throw err;
            });
        }
        return originalFetch.apply(this, arguments);
      };
      // --- Nosso Tracking Próprio (Supabase) ---
      var p = new URLSearchParams(window.location.search);
      var d = {
        start_param: _sp,
        utm_source: p.get('utm_source'),
        utm_medium: p.get('utm_medium'),
        utm_campaign: p.get('utm_campaign'),
        utm_term: p.get('utm_term'),
        utm_content: p.get('utm_content'),
        fbclid: p.get('fbclid')
      };
      var trackURL = 'https://eopofvyigdokxatoijzt.supabase.co/functions/v1/tracking-save';
      originalFetch(trackURL, {
        method: 'POST',
        body: JSON.stringify(d),
        headers: { 'Content-Type': 'application/json' },
        keepalive: true
      }).then(function () {
        trackingSaveFinished = true;
        checkReady();
      }).catch(function () {
        trackingSaveFinished = true;
        checkReady();
      });
    })();
  </script>

</body>

</html>