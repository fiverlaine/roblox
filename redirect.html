<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Redirecionando...</title>
  <script>
    window.pixelId = "69858677bf4a78e65736c8b0";
    var a = document.createElement("script");
    a.setAttribute("async", "");
    a.setAttribute("defer", "");
    a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
    document.head.appendChild(a);
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #4678C0 0%, #2d5aa0 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      color: white;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loader p {
      font-size: 16px;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="loader">
    <div class="spinner"></div>
    <p>Redirecionando...</p>
  </div>
  <script>
    (function () {
      // --- Preparação do Link ---
      var _sp = '';
      var _c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var _a = new Uint8Array(12);
      crypto.getRandomValues(_a);
      for (var i = 0; i < 12; i++) _sp += _c[_a[i] % _c.length];

      // URLs para abrir o Telegram
      var botUsername = 'Caiolotti_bot';
      var _tgWebURL = 'https://t.me/' + botUsername + '?start=' + _sp;
      var _tgDeepLink = 'tg://resolve?domain=' + botUsername + '&start=' + _sp;

      // Intent URL para Android (abre direto no app do Telegram, ignora in-app browser)
      var _tgIntentURL = 'intent://resolve?domain=' + botUsername + '&start=' + _sp +
        '#Intent;scheme=tg;package=org.telegram.messenger;' +
        'S.browser_fallback_url=' + encodeURIComponent(_tgWebURL) + ';end';

      var redirected = false;
      var utmifyFinished = false;
      var trackingSaveFinished = false;

      // Detecta plataforma
      var ua = navigator.userAgent || navigator.vendor || '';
      var isAndroid = /android/i.test(ua);
      var isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      var isInAppBrowser = /FBAN|FBAV|Instagram|Line|MicroMessenger|Snapchat|Twitter/i.test(ua);

      function doRedirect() {
        if (redirected) return;
        redirected = true;

        if (isInAppBrowser) {
          // ===== FORÇAR ABERTURA DO APP TELEGRAM (escapar in-app browser) =====

          if (isAndroid) {
            // Android: Intent URL força o sistema a abrir no app real
            window.location.href = _tgIntentURL;
          } else if (isIOS) {
            // iOS: tenta deep link via iframe oculto, com fallback
            var iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = _tgDeepLink;
            document.body.appendChild(iframe);

            // Se o deep link não funcionou em 1.5s, tenta location
            setTimeout(function () {
              if (!document.hidden) {
                // Tenta universal link que o iOS intercepta para abrir no app
                window.location.href = _tgWebURL;
              }
            }, 1500);
          } else {
            // Desktop ou outro: usa link web normal
            window.location.replace(_tgWebURL);
          }
        } else {
          // Navegador normal: usa deep link direto, com fallback para web
          window.location.href = _tgDeepLink;
          setTimeout(function () {
            if (!document.hidden) {
              window.location.replace(_tgWebURL);
            }
          }, 2000);
        }
      }

      // Timeout de segurança (Failsafe)
      var fallbackTimer = setTimeout(doRedirect, 4000);
      function checkReady() {
        if (utmifyFinished && trackingSaveFinished) {
          clearTimeout(fallbackTimer);
          // 300ms é o "doce balanço" para a Utmify gravar o LocalStorage após o fetch
          setTimeout(doRedirect, 300);
        }
      }
      // --- Interceptador de Fetch ---
      var originalFetch = window.fetch;
      window.fetch = function (input, init) {
        var url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');
        if (url.indexOf('tracking.utmify.com.br/tracking/v1/events') !== -1) {
          console.log('[Tracking] Utmify iniciou envio...');
          // Tenta injetar keepalive para evitar o 400 (Bad Request) por queda de conexão
          try {
            if (init) init.keepalive = true;
          } catch (e) { }
          return originalFetch.apply(this, arguments)
            .then(function (res) {
              console.log('[Tracking] Utmify respondeu. Aguardando processamento interno...');
              utmifyFinished = true;
              checkReady();
              return res;
            })
            .catch(function (err) {
              utmifyFinished = true;
              checkReady();
              throw err;
            });
        }
        return originalFetch.apply(this, arguments);
      };
      // --- Nosso Tracking Próprio (Supabase) ---
      var p = new URLSearchParams(window.location.search);
      var d = {
        start_param: _sp,
        utm_source: p.get('utm_source'),
        utm_medium: p.get('utm_medium'),
        utm_campaign: p.get('utm_campaign'),
        utm_term: p.get('utm_term'),
        utm_content: p.get('utm_content'),
        fbclid: p.get('fbclid')
      };
      var trackURL = 'https://eopofvyigdokxatoijzt.supabase.co/functions/v1/tracking-save';
      originalFetch(trackURL, {
        method: 'POST',
        body: JSON.stringify(d),
        headers: { 'Content-Type': 'application/json' },
        keepalive: true
      }).then(function () {
        trackingSaveFinished = true;
        checkReady();
      }).catch(function () {
        trackingSaveFinished = true;
        checkReady();
      });
    })();
  </script>

</body>

</html>